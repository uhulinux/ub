#!/bin/sh -eux

_certdir="$UB_INSTALLDIR"/usr/share/ca-certificates

mkdir -p "$_certdir"/mozilla

# mozilla certificates
install -Dm644 certs/*.crt "$_certdir"/mozilla/

# cacert.org certificates
install -Dm644 CAcert.org_root.crt "$_certdir"/
install -Dm644 CAcert.org_class3.crt "$_certdir"/

install -Dm755 update-ca-certificates "${UB_INSTALLDIR}"/usr/sbin/

mkdir -p $UB_INSTALLDIR/etc/ssl/certs

relp=$(echo "${UB_INSTALLDIR}" | sed -e 's:[^/]\+:..:g')
sed -i \
	-e '/="$ROOT/s:ROOT/:ROOT'"${UB_INSTALLDIR}"'/:' \
	-e '/RELPATH="\.\./s:"$:'"${relp}"'":' \
	update-ca-certificates
(
echo "# Automatically generated by update-ca-certificates"
echo "# $(date -u)"
echo "# Do not edit."
cd "${UB_INSTALLDIR}"/usr/share/ca-certificates
find * -name '*.crt' | LC_ALL=C sort
) > "${UB_INSTALLDIR}"/etc/ca-certificates.conf

sh "${UB_INSTALLDIR}"/usr/sbin/update-ca-certificates --root "${UB_INSTALLDIR}"
